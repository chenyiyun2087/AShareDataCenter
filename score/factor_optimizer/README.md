# 因子组合优化器 (Factor Optimizer)

基于 Walk-Forward 滚动前推的因子权重优化框架，用于寻找最优因子组合并防止过拟合。

---

## 设计思路

### 问题

系统有 9 大类因子（动量、价值、质量、技术、资金、筹码、市值、流动性、风险），每类因子有若干子因子。
核心问题：**各类因子该分配多少权重，才能构建最优的选股组合？**

### 方案

采用 **方案 C（混合方案）**：

1. **子因子评分不变** — 沿用 DWS 层已有的打分逻辑（阈值、Z-score 等）
2. **大类加总** — 每个大类内的子因子分数相加得到该大类分数
3. **只优化大类权重** — 7 个参数：`total = w1×动量 + w2×价值 + w3×质量 + w4×技术 + w5×资金 + w6×筹码 + w7×市值`

> 相比子因子级别优化（30+ 参数），只有 7 个参数，过拟合风险最低。

### 因子角色

| 类别 | 角色 | 说明 |
|:---|:---|:---|
| 动量 | ✅ Alpha 打分 | 5/20/60 日收益、MTM、量比等 |
| 价值 | ✅ Alpha 打分 | PE/PB/PS、账面市值比 |
| 质量 | ✅ Alpha 打分 | ROE、毛利率、杜邦分析 |
| 技术 | ✅ Alpha 打分 | MACD/KDJ/RSI/CCI/BIAS |
| 资金 | ✅ Alpha 打分 | 主力净流入、融资净买入 |
| 筹码 | ✅ Alpha 打分 | 获利比例、成本偏离、筹码峰穿越 |
| 市值 | ✅ Alpha 打分 | 流通市值（小盘溢价） |
| 流动性 | 🔶 仅过滤器 | 低流动性 = 执行风险 |
| 风险 | 🔶 仅过滤器 | 限制回撤敞口 |

---

## 防过拟合策略

| 技术 | 说明 |
|:---|:---|
| **Walk-Forward** | 训练窗口不断扩大，测试窗口在未来，杜绝未来函数 |
| **权重约束** | 每个大类 ∈ [5%, 30%]，防止单因子主导 |
| **换手率惩罚** | Top 5 集中持仓换手成本高，优化目标中惩罚高换手 |
| **多指标评估** | 优化夏普率，同时报告索提诺、最大回撤、卡尔马比率 |
| **样本外保留** | 最后 6 个月从未参与优化，作为终极验证 |
| **权重取整** | 最终权重取整到 5%，避免精度过拟合 |

### Walk-Forward 流程

```
第 1 折：训练 2022-01~2023-06 → 测试 2023-07~2023-12
第 2 折：训练 2022-01~2023-12 → 测试 2024-01~2024-06
第 3 折：训练 2022-01~2024-06 → 测试 2024-07~2024-12
第 4 折：训练 2022-01~2024-12 → 测试 2025-01~2025-06

最终 OOS：各折平均权重 → 测试 2025-07~2025-12
```

---

## 回测参数

| 参数 | 值 |
|:---|:---|
| 回测区间 | 2022-01-01 → 2025-12-31（4 年） |
| 持股周期 | 20 个交易日（月度调仓） |
| 选股数量 | Top 5（集中持仓） |
| 基准 | 沪深 300（CSI 500 未同步） |
| 交易成本 | 佣金 0.03% + 印花税 0.1%（卖出） + 滑点 0.1% |

---

## 文件结构

```
score/factor_optimizer/
├── __init__.py          # 包初始化
├── __main__.py          # python -m 入口
├── config.py            # 配置（日期、约束、参数）
├── data_loader.py       # 从 DWS 表 + dwd_daily_basic 加载数据
├── backtest.py          # 回测引擎（T-1打分、涨停过滤、交易成本）
├── optimizer.py         # Walk-Forward 权重优化（scipy SLSQP）
├── metrics.py           # 绩效指标（夏普/索提诺/最大回撤/卡尔马）
├── report.py            # Excel 报告（5 个 Sheet）
└── run_optimizer.py     # CLI 入口（argparse）
```

### 数据来源

| 数据 | 来源表 |
|:---|:---|
| 动量评分 | `dws_momentum_score` |
| 价值评分 | `dws_value_score` |
| 质量评分 | `dws_quality_score` |
| 技术评分 | `dws_technical_score` |
| 资金评分 | `dws_capital_score` |
| 筹码评分 | `dws_chip_score` |
| 市值评分 | `dwd_daily_basic.circ_mv`（在线计算） |
| 行情数据 | `ods_daily` |
| 基准数据 | `ods_index_daily` |

---

## 使用方式

```bash
# 快速测试（1 个月，1 折，验证流程）
.venv/bin/python -m score.factor_optimizer --dry-run

# 全量运行（4 年，4 折 Walk-Forward）
.venv/bin/python -m score.factor_optimizer

# 自定义参数
.venv/bin/python -m score.factor_optimizer \
    --start 20220101 \
    --end 20251231 \
    --top-n 5 \
    --holding-days 20

# 详细日志
.venv/bin/python -m score.factor_optimizer -v

# 指定输出文件
.venv/bin/python -m score.factor_optimizer --output my_report.xlsx
```

### 输出

运行后生成 Excel 报告，包含 5 个 Sheet：

| Sheet | 内容 |
|:---|:---|
| Weight Summary | 各折权重 + 平均权重 + 取整权重 |
| Fold Details | 每折训练/测试期的夏普、收益、回撤对比 |
| OOS Results | 样本外最终测试的所有绩效指标 |
| Equity Curves | 各折净值曲线 + 基准对比 |
| Stability Analysis | 权重稳定性（标准差、变异系数） |

---

## 关键指标说明

| 指标 | 含义 | 参考标准 |
|:---|:---|:---|
| **夏普率 (Sharpe)** | 每单位风险的超额收益 | > 1.0 良好，> 2.0 优秀 |
| **索提诺 (Sortino)** | 只考虑下行风险的收益比 | > 1.5 良好 |
| **最大回撤 (MaxDD)** | 净值最高点到最低点的跌幅 | < -20% 需警惕 |
| **卡尔马 (Calmar)** | 年化收益 / 最大回撤 | > 1.0 良好 |
| **换手率** | 单次调仓变动比例 | 越低越好（降低成本） |
| **权重稳定性** | 各折权重的标准差 | < 0.05 说明未过拟合 |

## 因子设置与计算公式

以下为各因子的具体计算规则与评分逻辑（源自 DWS 层）：

### 1. 动量 (Momentum)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **短期收益** | 5日/20日收益率 | >10%: 3分; >5%: 2分; >0%: 1分 |
| **长期收益** | 60日收益率 | >30%: 3分; >10%: 2分; >0%: 1分 |
| **趋势强度** | MTM指标 | >1.0: 5分; >0.5: 4分; >0: 2分 |
| **均线交叉** | MTM vs MTMMA | 金叉且>0: 4分; 金叉: 3分; 双多头: 2分 |
| **量能** | 量比 / 换手率 | 量比>1.5: 4分; 换手>10%: 4分 |

### 2. 价值 (Value)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **PE (TTM)** | 市盈率 | <15: 7分; <25: 5分; <40: 3分 |
| **PB** | 市净率 | <1.0: 7分; <2.0: 6分; <3.0: 4分 |
| **PS (TTM)** | 市销率 | <1.0: 6分; <2.0: 5分; <3.0: 3分 |

### 3. 质量 (Quality)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **盈利能力** | ROE (TTM) | >20%: 8分; >15%: 6分; >10%: 4分 |
| **毛利率** | Gross Margin | >50%: 6分; >30%: 5分; >20%: 3分 |
| **偿债能力** | 资产负债率 | <30%: 6分; <50%: 5分; <70%: 3分 |

### 4. 技术 (Technical)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **MACD** | 趋势指标 | DIF>DEA & MACD>0: 4分; MACD>0: 2分 |
| **KDJ** | 超买超卖 | J<20 (超卖): 3分; 40-60: 2分; >80: 0分 |
| **RSI** | 相对强弱 | <30: 3分; 40-60: 2分 |
| **CCI** | 顺势指标 | >100: 3分; >0: 2分; <-100: 2分 |
| **BIAS** | 乖离率 | <-3: 2分; -1~1: 1分 |

### 5. 资金 (Capital)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **超大单** | 净流入金额 | >1亿: 5分; >5000万: 4分; >1000万: 2分 |
| **大单** | 净流入金额 | >5000万: 3分; >2000万: 2分; >0: 1分 |
| **融资** | 净买入占比 | >2%: 2分; >0.5%: 1.5分 |

### 6. 筹码 (Chip)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **获利比例** | 获利盘占比 | <10% (极度超跌): 6分; <30%: 5分 |
| **成本偏离** | 现价/均价 | >1.1 (突破): 4分; >1.05: 3分; >1.0: 2分 |

### 7. 市值 (Size)
| 因子名 | 逻辑 | 评分规则 |
|:---|:---|:---|
| **流通市值** | 小盘股溢价 | <30亿: 10分; <80亿: 8分; <200亿: 6分; <500亿: 4分; >1000亿: 1分 |

---

## 默认配置参数 (Config)

| 参数项 | 默认值 | 说明 |
|:---|:---|:---|
| **回测区间** | 2022-01-01 ~ 2025-12-31 | 覆盖牛熊周期 |
| **持仓数量** | Top 5 | 集中持仓策略 |
| **调仓周期** | 20 个交易日 | 月度调仓 |
| **基准指数** | 000300.SH (沪深300) | 暂替代未同步的 CSI 500 |
| **交易佣金** | 0.03% | 双边 |
| **印花税** | 0.1% | 卖出单边 |
| **滑点** | 0.1% | 双边估算 |
| **权重下限** | 0.05 (5%) | 防止因子被完全剔除 |
| **权重上限** | 0.30 (30%) | 防止单因子过度主导 |
| **换手惩罚** | 0.002 | 优化目标函数中的惩罚系数 |
| **权重步长** | 0.05 | 结果取整步长 |


---

## 全量回测结论 (2025-02-15)

基于 2022-01-01 至 2025-12-31 的 4 年数据（含 2025 下半年 OOS 测试）的全量回测结果：

### 1. 组合规模对比 (OOS 2025 H2)

| 组合规模 | OOS 夏普率 | OOS 总收益 | OOS 最大回撤 | 权重分配 |
|:---|:---|:---|:---|:---|
| **Top 5** | 1.335 | **18.3%** | -19.4% | 等权 (14%) |
| **Top 7** | 0.994 | 11.5% | -14.4% | 等权 (14%) |
| **Top 10** | **1.468** | 16.2% | **-10.8%** | 等权 (14%) |

### 2. 关键发现

1.  **Top 10 性价比最高**：夏普率最高 (1.468)，最大回撤最低 (-10.8%)，收益率 (16.2%) 仅略低于 Top 5。适当分散显著降低了波动风险。
2.  **Top 5 进攻性最强**：收益最高但回撤接近 20%，适合高风险偏好。
3.  **熊市训练导致等权**：由于 2022-2024 年为长期熊市，训练期夏普率普便为负，优化器无法识别出有效因子，因此收敛到**等权配置**（即每个大类因子权重均为 14%）。这是防过拟合机制的正常体现。

### 3. 策略建议

**推荐策略**：**Top 10 + 等权配置**
- **稳健性**：Top 10 在 OOS 期间表现出最好的风险调整后收益。
- **抗风险**：最大回撤控制在 10% 左右，优于 Top 5 的近 20%。
